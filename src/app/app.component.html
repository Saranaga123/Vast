<div class="app-container">

  <!-- Guardian Selection -->
  <div class="guardian-selection" *ngIf="!playerGuardianAssigned">
    <button (click)="assignRandomGuardian()">ğŸ›¡ï¸ Select Your Guardian</button>
  </div>

  <!-- Main Game UI -->
  <div *ngIf="playerGuardianAssigned">

    <!-- Header -->
    <header> 
      <span>ğŸ—¡ï¸ The Last Guardian ğŸ‰</span>
    </header>
    <button class="fullscreen-btn" (click)="toggleFullscreen()">
      <span *ngIf="!isFullscreen">ğŸ—–</span>
      <span *ngIf="isFullscreen">ğŸ—•</span>
    </button>

    <main>

      <!-- Biome Selection -->
      <div class="biome-selection">
        <label for="biome">ğŸŒ¿ Select Biome: </label>
        <select id="biome" [(ngModel)]="selectedBiome">
          <option *ngFor="let biome of biomes" [value]="biome">{{ biome | titlecase }}</option>
        </select>
        <!-- <button (click)="searchEnemy()" [disabled]="currentEnemy || !selectedBiome">ğŸ” Search</button> -->
      </div>

      <!-- Battle Tables: Guardian vs Enemy -->
      <div class="battle-tables" *ngIf="currentEnemy && guardian">
        <!-- Guardian Table -->
        <table class="side-table">
          <caption>ğŸ›¡ï¸ Your Guardian</caption>
          <tr><td colspan="2" class="entity-img" style="text-align: center;"><img [src]="guardian.imageUrl" [alt]="guardian.name" class="guardian-gif" style="height:70px"> </td></tr>
          <tr> <td colspan="2" ><span *ngIf="guardian.hp >= 300 && guardian.hp <= 500 ">Celestial </span><span *ngIf="guardian.hp >= 500  ">Demigod </span>{{guardian.name}}</td></tr>
          <tr><td>â¤ï¸ HP:</td><td>{{guardian.hp | number:'1.0-2'}}</td></tr>
          <tr><td>âš”ï¸ STR:</td><td>{{guardian.str | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ›¡ï¸ DEF:</td><td>{{guardian.def | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ’¨ SPD:</td><td>{{guardian.spd | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ”¥ Attack</td><td>{{calculateDamage(guardian, currentEnemy)}}</td></tr>
          <tr><td>ğŸ’¨ Dodge</td><td>{{calculateDodgeChance(currentEnemy, guardian)}}%</td></tr>
          <tr><td>ğŸƒ Escape</td><td>{{calculateDodgeChance(guardian, currentEnemy)}}%</td></tr>
        </table>

        <!-- Enemy Table -->
        <table class="side-table">
          <caption>ğŸ‘¹ Enemy</caption>
          <tr><td colspan="2" class="entity-img" style="text-align: center !important;"><img [src]="currentEnemy.imageUrl" [alt]="currentEnemyEmoji" class="enemy-gif" style="height:70px"/></td></tr>
          <tr> <td colspan="2">{{currentEnemy.name}}</td></tr>
          <tr><td>â¤ï¸ HP:</td><td>{{currentEnemy.hp}}</td></tr>
          <tr><td>âš”ï¸ STR:</td><td>{{currentEnemy.str}}</td></tr>
          <tr><td>ğŸ›¡ï¸ DEF:</td><td>{{currentEnemy.def}}</td></tr>
          <tr><td>ğŸ’¨ SPD:</td><td>{{currentEnemy.spd}}</td></tr>
          <tr><td>ğŸ”¥ Attack</td><td>{{calculateDamage(currentEnemy, guardian)}}</td></tr>
          <tr><td>ğŸ’¨ Dodge</td><td>{{calculateDodgeChance(guardian, currentEnemy)}}%</td></tr>
        </table>
      </div>

      <!-- Guardian Stats Panel (No Enemy) -->
      <div class="stats-panel" *ngIf="!currentEnemy && guardian">
        <h3>ğŸ›¡ï¸ Guardian Stats</h3>
        <table>
          <tr><td colspan="2" class="entity-img" style="text-align: center;"><img [src]="guardian.imageUrl" [alt]="guardianEmoji" class="enemy-gif" style="height:70px; "/> </td></tr>
          <tr><td>ğŸ“ Name:</td><td><span *ngIf="guardian.hp >= 300 && guardian.hp <= 500 ">Celestial </span><span *ngIf="guardian.hp >= 500  ">Demigod </span>{{guardian.name}}</td></tr>
          <tr><td>â¤ï¸ HP:</td><td>{{guardian.hp | number:'1.0-2'}}</td></tr>
          <tr><td>âš”ï¸ STR:</td><td>{{guardian.str | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ›¡ï¸ DEF:</td><td>{{guardian.def | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ’¨ SPD:</td><td>{{guardian.spd | number:'1.0-2'}}</td></tr>
        </table>
<!-- ğŸ¯ Skill Points Panel -->
<div class="skills-panel" *ngIf="skillPoints > 0" style="margin-top:8px;">
  <h4>âœ¨ Skill Points: {{ skillPoints }}</h4>
  <button (click)="spendSkillPoint('str')">âš”ï¸ + STR</button>
  <button (click)="spendSkillPoint('def')">ğŸ›¡ï¸ + DEF</button>
  <button (click)="spendSkillPoint('spd')">ğŸ’¨ + SPD</button>
</div>
        <!-- Boss Info & Button -->
        <div *ngIf="guardian.hp >= 100 && bossesDefeated < totalBossesToWin">
          <p>âš ï¸ Boss Fights Available! Defeat {{ totalBossesToWin - bossesDefeated }} more bosses to win!</p>
          <button (click)="searchBoss()">ğŸ‘¹ Fight a Boss</button>
        </div>

        <!-- Game Won Panel -->
        <div *ngIf="gameWon">
          <p>ğŸ‰ You have completed all boss fights! Do you want to restart a new journey?</p>
          <button (click)="resetGame()">â³ Start New Journey</button>
        </div>
      </div>

      <!-- Healing Info -->
      <p *ngIf="guardianRegenMessage">{{ guardianRegenMessage }}</p>

      <!-- Messages / Attack Log -->
      <div class="messages" #messagesContainer>
        <p *ngFor="let msg of messages">ğŸ’¬ {{msg}}</p>
      </div>

    </main>

    <!-- âœ… Population Button (fixed position, always accessible) -->
    <div class="population-btn" style="text-align:center; margin:1vh 0;">
      <button (click)="showPopulation = true">ğŸŒ View Populations</button>
    </div>
    <div class="popup" *ngIf="showPopulation">
      <div class="popup-content">
        <button (click)="showPopulation = false" style="margin-left: 77%;">âŒ Close</button>
        <h2>ğŸŒ Current Populations</h2>

        <h3>ğŸ¹ Tribes</h3>
        <table>
          <tr *ngFor="let tribe of tribes">
            <td>{{tribe.name}}</td>
            <td>{{tribe.population}}</td>
          </tr>
        </table>

        <h3>ğŸ¾ Animals</h3>
        <table>
          <tr *ngFor="let animal of animals">
            <td>{{animal.name}}</td>
            <td>{{animal.count}}</td>
          </tr>
        </table>

        <button (click)="showPopulation = false"style="margin-left: 77%;">âŒ Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Guardian Slain Popup -->
<div class="popup" *ngIf="showGuardianSlainPopup">
  <div class="popup-content">
    <h2>ğŸ’€ Your Guardian was defeated!</h2> 
    <img src="assets/game over.gif"   style="height:360px"><br>
    <button (click)="selectNewGuardian()">ğŸ›¡ï¸ Rewind Time </button>
  </div>
</div>

<!-- Fixed Mobile-Friendly Action Panel -->
<div class="action-panel" *ngIf="playerGuardianAssigned">
  <ng-container *ngIf="guardian; else selectGuardian">
    
    <button (click)="searchEnemy()" [disabled]="!!currentEnemy || !selectedBiome">ğŸ” Search</button>
    <button (click)="attackEnemy()" [disabled]="!currentEnemy">âš”ï¸ Attack</button>
    <button (click)="autoAttackEnemy()" [disabled]="!currentEnemy">âš”ï¸ Auto âš”ï¸</button>
    <button (click)="escape()" [disabled]="!currentEnemy">ğŸƒ Escape</button>

    <!-- <button 
      (click)="searchBoss()" 
      *ngIf="guardian.hp >= 100 && bossesDefeated < totalBossesToWin && !currentEnemy">
      ğŸ‘¹ Boss Fight
    </button> -->
  </ng-container>

  <ng-template #selectGuardian>
    <button (click)="assignRandomGuardian()">ğŸ›¡ï¸ Select Guardian</button>
  </ng-template>
</div>
