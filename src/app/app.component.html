<div class="app-container">

  <!-- Guardian Selection -->
  <div class="guardian-selection" *ngIf="!playerGuardianAssigned">
    <button (click)="assignRandomGuardian()">ğŸ›¡ï¸ Select Your Guardian</button>
  </div>

  <!-- Main Game UI -->
  <div *ngIf="playerGuardianAssigned">

    <!-- Header -->
    <header>
      <br><br><br>
      <span>ğŸ—¡ï¸ The Last Guardian ğŸ‰</span>
      <button class="fullscreen-btn" (click)="toggleFullscreen()">
        <span *ngIf="!isFullscreen">ğŸ—–</span>
        <span *ngIf="isFullscreen">ğŸ—•</span>
      </button>
    </header>

    <main>

      <!-- Biome Selection -->
      <div class="biome-selection">
        <label for="biome">ğŸŒ¿ Select Biome:</label>
        <select id="biome" [(ngModel)]="selectedBiome">
          <option *ngFor="let biome of biomes" [value]="biome">{{ biome | titlecase }}</option>
        </select>
        <button (click)="searchEnemy()" [disabled]="currentEnemy || !selectedBiome">ğŸ” Search</button>
      </div>

      <!-- Battle Tables: Guardian vs Enemy -->
      <div class="battle-tables" *ngIf="currentEnemy && guardian">
        <!-- Guardian Table -->
        <table class="side-table">
          <caption>ğŸ›¡ï¸ Your Guardian</caption>
          <tr><td colspan="2" class="entity-img">{{guardianEmoji}}</td></tr>
          <tr><td>ğŸ“ Name:</td><td>{{guardian.name}}</td></tr>
          <tr><td>â¤ï¸ HP:</td><td>{{guardian.hp | number:'1.0-2'}} / {{guardianMaxHp}}</td></tr>
          <tr><td>âš”ï¸ STR:</td><td>{{guardian.str | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ›¡ï¸ DEF:</td><td>{{guardian.def | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ’¨ SPD:</td><td>{{guardian.spd | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ”¥ Attack â†’</td><td>{{calculateDamage(guardian, currentEnemy)}}</td></tr>
          <tr><td>ğŸ’¨ Dodge â†’</td><td>{{calculateDodgeChance(currentEnemy, guardian)}}%</td></tr>
          <tr><td>ğŸƒ Escape â†’</td><td>{{calculateDodgeChance(guardian, currentEnemy)}}%</td></tr>
        </table>

        <!-- Enemy Table -->
        <table class="side-table">
          <caption>ğŸ‘¹ Enemy</caption>
          <tr><td colspan="2" class="entity-img">{{currentEnemyEmoji}}</td></tr>
          <tr><td>ğŸ“ Name:</td><td>{{currentEnemy.name}}</td></tr>
          <tr><td>â¤ï¸ HP:</td><td>{{currentEnemy.hp}}</td></tr>
          <tr><td>âš”ï¸ STR:</td><td>{{currentEnemy.str}}</td></tr>
          <tr><td>ğŸ›¡ï¸ DEF:</td><td>{{currentEnemy.def}}</td></tr>
          <tr><td>ğŸ’¨ SPD:</td><td>{{currentEnemy.spd}}</td></tr>
          <tr><td>ğŸ”¥ Attack â†’</td><td>{{calculateDamage(currentEnemy, guardian)}}</td></tr>
          <tr><td>ğŸ’¨ Dodge â†’</td><td>{{calculateDodgeChance(guardian, currentEnemy)}}%</td></tr>
        </table>
      </div>

      <!-- Guardian Stats Panel (No Enemy) -->
      <div class="stats-panel" *ngIf="!currentEnemy && guardian">
        <h3>ğŸ›¡ï¸ Guardian Stats</h3>
        <table>
          <tr><td colspan="2" class="entity-img">{{guardianEmoji}}</td></tr>
          <tr><td>ğŸ“ Name:</td><td>{{guardian.name}}</td></tr>
          <tr><td>â¤ï¸ HP:</td><td>{{guardian.hp | number:'1.0-2'}} / {{guardianMaxHp}}</td></tr>
          <tr><td>âš”ï¸ STR:</td><td>{{guardian.str | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ›¡ï¸ DEF:</td><td>{{guardian.def | number:'1.0-2'}}</td></tr>
          <tr><td>ğŸ’¨ SPD:</td><td>{{guardian.spd | number:'1.0-2'}}</td></tr>
        </table>

        <!-- Skill Points Panel -->
        <div *ngIf="skillPoints > 0" class="skill-panel">
          <p>â­ Skill Points: {{ skillPoints }}</p>
          <button (click)="spendSkillPoint('str')">+ STR</button>
          <button (click)="spendSkillPoint('def')">+ DEF</button>
          <button (click)="spendSkillPoint('spd')">+ SPD</button>
        </div>

        <!-- Boss Info & Button -->
        <div *ngIf="guardian.hp >= 100 && bossesDefeated < totalBossesToWin">
          <p>âš ï¸ Boss Fights Available! Defeat {{ totalBossesToWin - bossesDefeated }} more bosses to win!</p>
          <button (click)="searchBoss()">ğŸ‘¹ Fight a Boss</button>
        </div>

        <!-- Game Won Panel -->
        <div *ngIf="gameWon">
          <p>ğŸ‰ You have completed all boss fights! Do you want to restart a new journey?</p>
          <button (click)="resetGame()">â³ Start New Journey</button>
        </div>

      </div>

      <!-- Healing Info -->
      <p *ngIf="guardianRegenMessage">{{ guardianRegenMessage }}</p>

      <!-- Messages / Attack Log -->
      <div class="messages" #messagesContainer>
        <p *ngFor="let msg of messages">ğŸ’¬ {{msg}}</p>
      </div>

    </main>

  </div>
</div>

<!-- Guardian Slain Popup -->
<div class="popup" *ngIf="showGuardianSlainPopup">
  <div class="popup-content">
    <h2>ğŸ’€ Your Guardian was defeated!</h2> 
    <button (click)="selectNewGuardian()">ğŸ›¡ï¸ Select New Guardian</button>
  </div>
</div>

<!-- Fixed Mobile-Friendly Action Panel -->
<div class="action-panel" *ngIf="playerGuardianAssigned">

  <ng-container *ngIf="guardian; else selectGuardian">
    <button (click)="searchEnemy()" [disabled]="!!currentEnemy || !selectedBiome">ğŸ” Search</button>
    <button (click)="attackEnemy()" [disabled]="!currentEnemy">âš”ï¸ Attack</button>
    <button (click)="autoAttackEnemy()" [disabled]="!currentEnemy">âš”ï¸ Auto âš”ï¸</button>
    <button (click)="escape()" [disabled]="!currentEnemy">ğŸƒ Escape</button>
    <button (click)="searchBoss()" *ngIf="guardian.hp >= 100 && bossesDefeated < totalBossesToWin && !currentEnemy">ğŸ‘¹ Boss Fight</button>
  </ng-container>

  <ng-template #selectGuardian>
    <button (click)="assignRandomGuardian()">ğŸ›¡ï¸ Select Guardian</button>
  </ng-template>

</div>
